<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Delta pressure - Southern Ocean</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@5.11.0/dist/maplibre-gl.css">
  <script src="https://unpkg.com/maplibre-gl@5.11.0/dist/maplibre-gl.js"></script>
  <style>
    html, body, #map { height: 100%; margin: 0; }
    body { background: #000; }
    
    .legend {
      position: absolute;
      bottom: 12px;
      left: 12px;
      background: rgba(255,255,255,0.9);
      padding: 10px 14px;
      border-radius: 6px;
      font: 13px/1.4 system-ui, sans-serif;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
      z-index: 2;
    }
    .legend strong { font-size: 14px; }
    
    .controls {
      position: absolute;
      bottom: 12px;
      right: 12px;
      background: rgba(255,255,255,0.9);
      padding: 10px 14px;
      border-radius: 6px;
      font: 13px/1.4 system-ui, sans-serif;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
      z-index: 2;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div class="legend">
  <strong>Delta-pressure [dbar]</strong>
  <div>1027.60 / 1027.61 [kg/mÂ³]</div>
  <div id="legend-date">Date: January 2004</div>
  <div style="margin-top:6px; height:12px; width:200px; background: linear-gradient(to right,#fdef9a, #78cb68, #3b9287, #0f5a91, #2a186c);"></div>
  <div style="display:flex; justify-content:space-between; font-size:11px;"><span>0</span><span>37</span></div>
</div>

<div class="controls">
  <button id="playPause">Pause</button>
  <input type="range" id="slider" min="0" max="239" value="0" style="width: 150px;">
</div>

<script>
  const START_YEAR = 2004;
  const TIME_VALUES = [
    "2004-01-16T12:00:00",
    "2004-02-15T12:00:00",
    "2004-03-16T12:00:00",
    "2004-04-16T00:00:00",
    "2004-05-16T12:00:00",
    "2004-06-16T00:00:00",
    "2004-07-16T12:00:00",
    "2004-08-16T12:00:00",
    "2004-09-16T00:00:00",
    "2004-10-16T12:00:00",
    "2004-11-16T00:00:00",
    "2004-12-16T12:00:00",
    "2005-01-16T12:00:00",
    "2005-02-15T00:00:00",
    "2005-03-16T12:00:00",
    "2005-04-16T00:00:00",
    "2005-05-16T12:00:00",
    "2005-06-16T00:00:00",
    "2005-07-16T12:00:00",
    "2005-08-16T12:00:00",
    "2005-09-16T00:00:00",
    "2005-10-16T12:00:00",
    "2005-11-16T00:00:00",
    "2005-12-16T12:00:00",
    "2006-01-16T12:00:00",
    "2006-02-15T00:00:00",
    "2006-03-16T12:00:00",
    "2006-04-16T00:00:00",
    "2006-05-16T12:00:00",
    "2006-06-16T00:00:00",
    "2006-07-16T12:00:00",
    "2006-08-16T12:00:00",
    "2006-09-16T00:00:00",
    "2006-10-16T12:00:00",
    "2006-11-16T00:00:00",
    "2006-12-16T12:00:00",
    "2007-01-16T12:00:00",
    "2007-02-15T00:00:00",
    "2007-03-16T12:00:00",
    "2007-04-16T00:00:00",
    "2007-05-16T12:00:00",
    "2007-06-16T00:00:00",
    "2007-07-16T12:00:00",
    "2007-08-16T12:00:00",
    "2007-09-16T00:00:00",
    "2007-10-16T12:00:00",
    "2007-11-16T00:00:00",
    "2007-12-16T12:00:00",
    "2008-01-16T12:00:00",
    "2008-02-15T12:00:00",
    "2008-03-16T12:00:00",
    "2008-04-16T00:00:00",
    "2008-05-16T12:00:00",
    "2008-06-16T00:00:00",
    "2008-07-16T12:00:00",
    "2008-08-16T12:00:00",
    "2008-09-16T00:00:00",
    "2008-10-16T12:00:00",
    "2008-11-16T00:00:00",
    "2008-12-16T12:00:00",
    "2009-01-16T12:00:00",
    "2009-02-15T00:00:00",
    "2009-03-16T12:00:00",
    "2009-04-16T00:00:00",
    "2009-05-16T12:00:00",
    "2009-06-16T00:00:00",
    "2009-07-16T12:00:00",
    "2009-08-16T12:00:00",
    "2009-09-16T00:00:00",
    "2009-10-16T12:00:00",
    "2009-11-16T00:00:00",
    "2009-12-16T12:00:00",
    "2010-01-16T12:00:00",
    "2010-02-15T00:00:00",
    "2010-03-16T12:00:00",
    "2010-04-16T00:00:00",
    "2010-05-16T12:00:00",
    "2010-06-16T00:00:00",
    "2010-07-16T12:00:00",
    "2010-08-16T12:00:00",
    "2010-09-16T00:00:00",
    "2010-10-16T12:00:00",
    "2010-11-16T00:00:00",
    "2010-12-16T12:00:00",
    "2011-01-16T12:00:00",
    "2011-02-15T00:00:00",
    "2011-03-16T12:00:00",
    "2011-04-16T00:00:00",
    "2011-05-16T12:00:00",
    "2011-06-16T00:00:00",
    "2011-07-16T12:00:00",
    "2011-08-16T12:00:00",
    "2011-09-16T00:00:00",
    "2011-10-16T12:00:00",
    "2011-11-16T00:00:00",
    "2011-12-16T12:00:00",
    "2012-01-16T12:00:00",
    "2012-02-15T12:00:00",
    "2012-03-16T12:00:00",
    "2012-04-16T00:00:00",
    "2012-05-16T12:00:00",
    "2012-06-16T00:00:00",
    "2012-07-16T12:00:00",
    "2012-08-16T12:00:00",
    "2012-09-16T00:00:00",
    "2012-10-16T12:00:00",
    "2012-11-16T00:00:00",
    "2012-12-16T12:00:00",
    "2013-01-16T12:00:00",
    "2013-02-15T00:00:00",
    "2013-03-16T12:00:00",
    "2013-04-16T00:00:00",
    "2013-05-16T12:00:00",
    "2013-06-16T00:00:00",
    "2013-07-16T12:00:00",
    "2013-08-16T12:00:00",
    "2013-09-16T00:00:00",
    "2013-10-16T12:00:00",
    "2013-11-16T00:00:00",
    "2013-12-16T12:00:00",
    "2014-01-16T12:00:00",
    "2014-02-15T00:00:00",
    "2014-03-16T12:00:00",
    "2014-04-16T00:00:00",
    "2014-05-16T12:00:00",
    "2014-06-16T00:00:00",
    "2014-07-16T12:00:00",
    "2014-08-16T12:00:00",
    "2014-09-16T00:00:00",
    "2014-10-16T12:00:00",
    "2014-11-16T00:00:00",
    "2014-12-16T12:00:00",
    "2015-01-16T12:00:00",
    "2015-02-15T00:00:00",
    "2015-03-16T12:00:00",
    "2015-04-16T00:00:00",
    "2015-05-16T12:00:00",
    "2015-06-16T00:00:00",
    "2015-07-16T12:00:00",
    "2015-08-16T12:00:00",
    "2015-09-16T00:00:00",
    "2015-10-16T12:00:00",
    "2015-11-16T00:00:00",
    "2015-12-16T12:00:00",
    "2016-01-16T12:00:00",
    "2016-02-15T12:00:00",
    "2016-03-16T12:00:00",
    "2016-04-16T00:00:00",
    "2016-05-16T12:00:00",
    "2016-06-16T00:00:00",
    "2016-07-16T12:00:00",
    "2016-08-16T12:00:00",
    "2016-09-16T00:00:00",
    "2016-10-16T12:00:00",
    "2016-11-16T00:00:00",
    "2016-12-16T12:00:00",
    "2017-01-16T12:00:00",
    "2017-02-15T00:00:00",
    "2017-03-16T12:00:00",
    "2017-04-16T00:00:00",
    "2017-05-16T12:00:00",
    "2017-06-16T00:00:00",
    "2017-07-16T12:00:00",
    "2017-08-16T12:00:00",
    "2017-09-16T00:00:00",
    "2017-10-16T12:00:00",
    "2017-11-16T00:00:00",
    "2017-12-16T12:00:00",
    "2018-01-16T12:00:00",
    "2018-02-15T00:00:00",
    "2018-03-16T12:00:00",
    "2018-04-16T00:00:00",
    "2018-05-16T12:00:00",
    "2018-06-16T00:00:00",
    "2018-07-16T12:00:00",
    "2018-08-16T12:00:00",
    "2018-09-16T00:00:00",
    "2018-10-16T12:00:00",
    "2018-11-16T00:00:00",
    "2018-12-16T12:00:00",
    "2019-01-16T12:00:00",
    "2019-02-15T00:00:00",
    "2019-03-16T12:00:00",
    "2019-04-16T00:00:00",
    "2019-05-16T12:00:00",
    "2019-06-16T00:00:00",
    "2019-07-16T12:00:00",
    "2019-08-16T12:00:00",
    "2019-09-16T00:00:00",
    "2019-10-16T12:00:00",
    "2019-11-16T00:00:00",
    "2019-12-16T12:00:00",
    "2020-01-16T12:00:00",
    "2020-02-15T12:00:00",
    "2020-03-16T12:00:00",
    "2020-04-16T00:00:00",
    "2020-05-16T12:00:00",
    "2020-06-16T00:00:00",
    "2020-07-16T12:00:00",
    "2020-08-16T12:00:00",
    "2020-09-16T00:00:00",
    "2020-10-16T12:00:00",
    "2020-11-16T00:00:00",
    "2020-12-16T12:00:00",
    "2021-01-16T12:00:00",
    "2021-02-15T00:00:00",
    "2021-03-16T12:00:00",
    "2021-04-16T00:00:00",
    "2021-05-16T12:00:00",
    "2021-06-16T00:00:00",
    "2021-07-16T12:00:00",
    "2021-08-16T12:00:00",
    "2021-09-16T00:00:00",
    "2021-10-16T12:00:00",
    "2021-11-16T00:00:00",
    "2021-12-16T12:00:00",
    "2022-01-16T12:00:00",
    "2022-02-15T00:00:00",
    "2022-03-16T12:00:00",
    "2022-04-16T00:00:00",
    "2022-05-16T12:00:00",
    "2022-06-16T00:00:00",
    "2022-07-16T12:00:00",
    "2022-08-16T12:00:00",
    "2022-09-16T00:00:00",
    "2022-10-16T12:00:00",
    "2022-11-16T00:00:00",
    "2022-12-16T12:00:00",
    "2023-01-16T12:00:00",
    "2023-02-15T00:00:00",
    "2023-03-16T12:00:00",
    "2023-04-16T00:00:00",
    "2023-05-16T12:00:00",
    "2023-06-16T00:00:00",
    "2023-07-16T12:00:00",
    "2023-08-16T12:00:00",
    "2023-09-16T00:00:00",
    "2023-10-16T12:00:00",
    "2023-11-16T00:00:00",
    "2023-12-16T12:00:00",
  ];
  const TOTAL_MONTHS = 240; //or use TIME_VALUES.length;
  
  const monthNames = [
    "January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"
  ];
  
  function getDateLabel(monthIndex) {
    const date = new Date(TIME_VALUES[monthIndex]);
    return `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
  }

  const TILE_SERVER = "https://deltapres-tiles-gcs.onrender.com";

  const halineR = {
    "0": "#fdef9a",
    "16": "#e1e57c",
    "32": "#c1dd64",
    "48": "#9bd55c",
    "64": "#78cb68",
    "80": "#5fbe75",
    "96": "#4faf7e",
    "112": "#44a184",
    "128": "#3b9287",
    "144": "#338488",
    "160": "#287689",
    "176": "#1b698c",
    "192": "#0f5a91",
    "208": "#0f4999",
    "224": "#2132a2",
    "240": "#2e1d91",
    "255": "#2a186c",
  };

  const colormapParam = encodeURIComponent(JSON.stringify(halineR));

  function getTileUrl(monthIndex) {
    const timeStr = TIME_VALUES[monthIndex];
    return `${TILE_SERVER}/datasets/mydata/tiles/WebMercatorQuad/{z}/{y}/{x}?variables=layer_thickness&time=${timeStr}&style=raster/custom&colormap=${colormapParam}&colorscalerange=0,40&width=256&height=256`;
  }

  const map = new maplibregl.Map({
    container: 'map',
    style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
    center: [0, -90],
    zoom: 1.5,
    maxZoom: 6,
    pitch: 0,
    bearing: 0,
    antialias: true,
    fadeDuration: 0
  });

  map.addControl(new maplibregl.NavigationControl(), 'top-right');

  let currentMonth = 0;
  let isPlaying = true;
  let animationInterval;

  map.on('style.load', () => {
    if (map.setProjection) map.setProjection({ type: 'globe' });
    if (map.setFog) map.setFog({ 'horizon-blend': 1.0 });

    // Hide basemap labels and lines
    (map.getStyle().layers || []).forEach(l => {
      if (l.type === 'line') map.setLayoutProperty(l.id, 'visibility', 'none');
      if (l.type === 'symbol') map.setLayoutProperty(l.id, 'visibility', 'none');
      if (l.type === 'fill' && /land|background/i.test(l.id)) {
        try { map.setPaintProperty(l.id, 'fill-color', '#0b0b0f'); } catch(e){}
      }
    });

    // Add single tile source
    map.addSource('data', {
      type: 'raster',
      tiles: [getTileUrl(0)],
      tileSize: 256,
      minzoom: 0,
      maxzoom: 6
    });

    map.addLayer({
      id: 'data-layer',
      type: 'raster',
      source: 'data',
      paint: { 'raster-fade-duration': 0 }
    });

    const legendEl = document.getElementById('legend-date');
    const slider = document.getElementById('slider');
    const playPauseBtn = document.getElementById('playPause');
    let sliderTimeout;

    function updateMonth(monthIndex) {
      currentMonth = monthIndex;
      map.getSource('data').setTiles([getTileUrl(monthIndex)]);
      legendEl.textContent = `Date: ${getDateLabel(monthIndex)}`;
      slider.value = monthIndex;
    }

    // Animation
    function startAnimation() {
      animationInterval = setInterval(() => {
        const nextMonth = (currentMonth + 1) % TOTAL_MONTHS;
        updateMonth(nextMonth);
      }, 1000); // 1 fps
    }

    function stopAnimation() {
      clearInterval(animationInterval);
    }

    // Controls
    playPauseBtn.addEventListener('click', () => {
      isPlaying = !isPlaying;
      playPauseBtn.textContent = isPlaying ? 'Pause' : 'Play';
      if (isPlaying) {
        startAnimation();
      } else {
        stopAnimation();
      }
    });

    // Stop animation and debounce tile updates while dragging slider
    slider.addEventListener('input', (e) => {
      stopAnimation();
      isPlaying = false;
      playPauseBtn.textContent = 'Play';

      const monthIndex = parseInt(e.target.value);
      
      // Update legend immediately for responsiveness
      currentMonth = monthIndex;
      legendEl.textContent = `Date: ${getDateLabel(monthIndex)}`;
      
      // Debounce tile fetching - only fetch after slider stops moving
      clearTimeout(sliderTimeout);
      sliderTimeout = setTimeout(() => {
        map.getSource('data').setTiles([getTileUrl(monthIndex)]);
      }, 250);  // Wait 250ms after last movement
    });

    // Resume animation after releasing slider (if was playing)
    slider.addEventListener('change', (e) => {
    });

    // Start animation
    startAnimation();
  });
</script>

</body>
</html>